# Telegram Webhook Mirror
# Mirrors webhooks to both OpenClaw and KCC Office simultaneously
#
# Start: nginx -c ~/.openclaw/nginx-telegram-mirror.conf
# Stop: nginx -c ~/.openclaw/nginx-telegram-mirror.conf -s stop

worker_processes 1;
error_log /tmp/nginx-telegram-mirror-error.log warn;
pid /tmp/nginx-telegram-mirror.pid;

events {
    worker_connections 128;
}

http {
    access_log /tmp/nginx-telegram-mirror-access.log;

    # OpenClaw (primary - returns response to Telegram)
    upstream openclaw {
        server 127.0.0.1:8787;
    }

    # KCC Office (mirror - fire and forget)
    upstream kcc_office {
        server 127.0.0.1:4200;
    }

    server {
        listen 8790;
        server_name localhost;

        # Telegram webhook endpoint
        location /api/telegram/webhook {
            # Mirror to KCC Office (non-blocking)
            mirror /mirror_kcc;
            mirror_request_body on;

            # Primary: forward to OpenClaw
            proxy_pass http://openclaw/api/telegram/webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Telegram-Bot-Api-Secret-Token $http_x_telegram_bot_api_secret_token;
            
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Internal mirror to KCC Office
        location = /mirror_kcc {
            internal;
            proxy_pass http://kcc_office/api/telegram/webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Telegram-Bot-Api-Secret-Token $http_x_telegram_bot_api_secret_token;
            
            # Short timeout - don't wait
            proxy_connect_timeout 2s;
            proxy_send_timeout 2s;
            proxy_read_timeout 2s;
        }

        # Health check
        location /health {
            return 200 'ok\n';
            add_header Content-Type text/plain;
        }
    }
}
