# Telegram Webhook Mirror for KCC Office
# Mirrors incoming webhooks to both OpenClaw and KCC Office simultaneously
#
# Usage: Include this in your nginx.conf or run standalone:
#   nginx -c /path/to/nginx-mirror.conf
#
# Then update CF tunnel to point to this nginx instead of OpenClaw directly

worker_processes 1;
error_log /tmp/nginx-telegram-mirror-error.log;
pid /tmp/nginx-telegram-mirror.pid;

events {
    worker_connections 128;
}

http {
    access_log /tmp/nginx-telegram-mirror-access.log;

    # Upstream: OpenClaw (primary - returns response to Telegram)
    upstream openclaw {
        server 127.0.0.1:8787;
    }

    # Upstream: KCC Office (mirror - fire and forget)
    upstream kcc_office {
        server 127.0.0.1:4200;
    }

    server {
        listen 8790;
        server_name localhost;

        # Telegram webhook endpoint
        location /api/telegram/webhook {
            # Mirror to KCC Office (fire-and-forget, non-blocking)
            mirror /mirror_kcc;
            mirror_request_body on;

            # Primary: forward to OpenClaw and return its response
            proxy_pass http://openclaw/telegram-webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Telegram-Bot-Api-Secret-Token $http_x_telegram_bot_api_secret_token;
            
            # Timeout settings
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Internal mirror location for KCC Office
        location = /mirror_kcc {
            internal;
            
            # Forward to KCC Office webhook endpoint
            proxy_pass http://kcc_office/api/telegram/webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Telegram-Bot-Api-Secret-Token $http_x_telegram_bot_api_secret_token;
            
            # Short timeout - don't wait for response
            proxy_connect_timeout 2s;
            proxy_send_timeout 2s;
            proxy_read_timeout 2s;
        }

        # Health check
        location /health {
            return 200 'nginx-mirror: ok\n';
            add_header Content-Type text/plain;
        }
    }
}
